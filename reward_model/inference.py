#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Date  : 2026/1/26 15:02
# @File  : inference.py.py
# @Author: johnson
# @Contact : github: johnson7788
# @Desc  : 奖励模型的推理


import torch

from transformers import AutoModelForSequenceClassification, AutoTokenizer

# Load model and tokenizer
device = "cuda:0"
model_name = "DPO_Reward"
rm = AutoModelForSequenceClassification.from_pretrained(
    model_name,
    torch_dtype=torch.bfloat16,
    device_map=device,
    attn_implementation="flash_attention_2",
    num_labels=1,
)
tokenizer = AutoTokenizer.from_pretrained(model_name)

one_data = {"prompt": "基于最新循证指南的综合治疗管理对于肝硬化患者的临床预后和并发症控制有何影响？", "chosen": "基于最新循证指南的“综合治疗管理”（multidisciplinary / comprehensive care bundle）对肝硬化患者的预后和并发症控制，已经有较清晰的证据：能**降低死亡率、减少失代偿事件、降低住院率和再入院率，并改善生活质量**。下面按循证依据和关键干预要点来说明。\n\n---\n\n## 一、总体影响：综合管理 vs. 常规随访\n\n### 1. 死亡率与失代偿事件\n\n1. **肝硬化门诊综合管理/护理路径**\n   - 多项队列研究和前瞻性研究显示，实施以指南为基础的“肝硬化管理路径”（包括筛查、预防、营养、药物规范化等）可：\n     - 使**1年死亡率下降约20–40%**（相对于零散、被动的常规照护）\n     - 明显降低**首次失代偿事件**（腹水、消化道出血、肝性脑病等）的发生率\n   - 机制：更早识别高危患者（如有临床显著门脉高压 CSPH、ALBI/Child-Pugh/CPT-B/C分级、MELD较高者），更规范使用预防性药物和干预（如非选择性β受体阻滞剂、EVL、利尿剂、白蛋白等）。\n\n2. **急性失代偿和急性-慢性肝功能衰竭（ACLF）的“治疗套餐（care bundle）”**\n   - EASL、BASL 等提出对急性失代偿/ACLF患者入院24小时内实施“bundles”：快速感染筛查、早期抗生素、早期白蛋白、肾功能保护、严格液体管理、早期ICU评估等。\n   - 研究显示：\n     - 使用标准化 care bundle，可**显著降低院内死亡率（约相对下降20–30%）**\n     - 减少急性肾损伤（AKI）及进展为ACLF的风险\n\n3. **肝癌（HCC）早筛与综合管理**\n   - 对失代偿或代偿期肝硬化患者，按照指南（AASLD/EASL/APASL）进行**每6个月超声 ± AFP监测**，配合多学科团队（MDT）评估治疗（切除、消融、TACE、系统治疗等）：\n     - 提高**早期HCC（BCLC 0–A期）发现率**\n     - 明显增加**可治愈性治疗比例**\n     - 与未规范筛查相比，可**改善总生存率**（多项观察研究和建模研究支持）\n\n### 2. 住院率与再入院率\n\n- 系统性综合管理（包括患者教育、营养师指导、药师参与、出院随访和电话管理）可：\n  - **减少失代偿相关住院**（腹水、脑病、出血）\n  - **降低30天和90天再入院率**，多项研究提示相对下降约20–40%\n- 机制：更好地控制体液平衡、避免诱因（感染、便秘、利尿剂误用、NSAIDs等）、提高药物依从性和饮食配合。\n\n### 3. 生活质量与功能状态\n\n- 综合管理方案（特别是纳入营养、运动、心理支持和社会支持）在多项研究中显示：\n  - 改善**健康相关生活质量量表**（如 SF‑36、CLDQ）\n  - 提高**肌力和体能**（通过阻力运动和营养干预）\n  - 减少焦虑和抑郁症状\n\n---\n\n## 二、关键循证干预模块及其对预后的具体影响\n\n综合治疗管理的核心是：**围绕“病因控制 + 门脉高压管理 + 并发症预防与营养/生活方式干预 + 早期识别高危和移植评估”，按指南系统执行**。下面分模块说明其对结局的影响。\n\n### 1. 病因治疗（Etiological therapy）\n\n**1）病毒性肝炎相关肝硬化**\n\n- HBV：指南（AASLD/EASL/APASL）均推荐对**代偿期和失代偿期HBV肝硬化**持续使用高效核苷（酸）类似物（如 entecavir、TDF、TAF）：\n  - 明确证据：可**降低失代偿、HCC和死亡风险**\n  - 对失代偿期：可改善肝功能评分，部分患者可从“不可移植”转为“可移植”状态，甚至“再代偿化”\n- HCV：DAA治疗可在肝硬化患者中达到>90% SVR：\n  - 对代偿期：**显著降低失代偿、HCC和死亡**\n  - 对失代偿期：可改善Child-Pugh和MELD分值，但HCC和失代偿风险不能完全消除，因此仍需继续综合管理与HCC监测\n\n**2）酒精性肝病**\n\n- 通过成瘾医学、心理干预和社会支持实现**持续戒酒**：\n  - 证据充分：戒酒可显著改善生存，部分患者肝功能可明显改善，甚至从失代偿转为代偿\n  - 综合管理模式下的戒酒干预（包含心理咨询、药物辅助、家庭参与）比单纯口头劝戒效果更好，长期生存获益更大\n\n**3）代谢相关脂肪性肝病（MASH/MAFLD）**\n\n- 体重减轻（7–10%）、控制糖脂代谢、血压和心血管危险因素：\n  - 可减缓或部分逆转纤维化进展\n  - 降低心血管事件和总体死亡\n- 指南推荐：多学科（肝病科+内分泌+营养+运动）联合管理优于单一专科随访\n\n**4）自身免疫性肝病、胆汁淤积性肝病等**\n\n- 规范免疫抑制（AIH）、UDCA/obeticholic acid（PBC）、内镜/外科治疗（PSC相关胆管病变）：\n  - 可延缓进展到失代偿，改善长期生存\n\n**结论**：病因控制是综合管理的首要环节，其单独就能显著改善预后，而在综合路径中执行更彻底、依从性更高。\n\n---\n\n### 2. 门脉高压与出血预防\n\n**1）非选择性β受体阻滞剂（NSBB）与内镜治疗**\n\n- 对中~高危静脉曲张患者，指南推荐：\n  - NSBB（propranolol / nadolol / carvedilol）或\n  - 内镜下静脉曲张套扎（EVL），或两者联合\n- 循证结果：\n  - NSBB可显著**降低首发和再发静脉曲张出血**，并降低失代偿风险\n  - 最新研究提示，在存在CSPH的代偿期肝硬化中，NSBB可**延缓或减少首次失代偿事件**，包括腹水和脑病\n- 综合管理路径中，系统筛查食管胃底静脉曲张并规范启动NSBB/EVL，可明显降低出血事件和相关死亡。\n\n**2）TIPS（经颈静脉肝内门体分流术）**\n\n- 在高危急性静脉曲张出血（如Child C 10–13分或Child B合并活动性出血）患者中，**早期TIPS**（<72小时）：\n  - RCT和Meta分析显示：**降低再出血和死亡率**\n- 对难治性腹水患者，TIPS可：\n  - 显著减少腹水复发和住院\n  - 在部分患者中改善生存，但需谨慎评估脑病和心功能\n- 综合管理要求：多学科团队（肝病+介入+麻醉+ICU）评估TIPS适应证与禁忌，优化时机。\n\n---\n\n### 3. 腹水与肾功能保护\n\n**1）腹水管理（盐限制、利尿剂、大量放腹水+白蛋白）**\n\n- 按指南规范：\n  - 适度限盐（通常 <5–6 g NaCl/d），螺内酯±呋塞米阶梯加量\n  - 大量放腹水（LVP）时联合白蛋白输注（通常 6–8 g/L 放出腹水）\n- 循证：\n  - 白蛋白联合LVP可**显著降低循环功能衰竭、AKI和再入院率**\n  - 规范利尿剂使用减少低钠血症和肾损害\n- 长期白蛋白治疗（如 ANSWER trial）在部分失代偿患者中：\n  - 改善生存，减少并发症（腹水、感染、肾功能恶化）\n  - 但需结合成本和个体风险获益评估（各指南态度略有差异）\n\n**2）肾功能保护与AKI/HRS管理**\n\n- 综合路径强调：\n  - 早期识别AKI（基于KDIGO或IAC criteria）\n  - 立即停用肾毒药物（NSAIDs、ACEI/ARB等）、纠正低血容量、早期白蛋白+血流动力学支持\n- 对HRS-AKI，指南推荐早期使用：\n  - **特利加压素 + 白蛋白**（或去甲肾上腺素+白蛋白等）\n  - 证据：可提高肾功能恢复率，改善短期生存\n- 在综合管理模式中，AKI/HRS的识别和处理更及时，**显著降低进展为ACLF和死亡**。\n\n---\n\n### 4. 肝性脑病（HE）预防与管理\n\n- 一线治疗：乳果糖\n- 二线或联合：利福昔明（尤其在复发性HE）\n- 循证：\n  - 乳果糖用于**二级预防**（既往有一次HE）可显著降低复发率和再入院\n  - 乳果糖 + 利福昔明 vs 单用乳果糖：\n    - 明显降低HE复发、住院率\n    - 有研究提示对生存有益\n- 综合管理包括：\n  - 系统识别诱因（感染、便秘、胃肠出血、电解质紊乱、药物）\n  - 患者与家属教育（早期识别精神状态改变）\n  - 药物依从性管理\n- 结果：**HE发作频率和住院率显著下降，生活质量明显改善**。\n\n---\n\n### 5. 感染预防与处理\n\n- 肝硬化患者感染（SBP、肺炎、尿路感染等）是失代偿和死亡的重要诱因。\n- 综合管理中的关键措施：\n  - 高危患者（既往SBP、低蛋白腹水、GI出血后）使用**预防性抗生素**（如诺氟沙星/复方制剂，根据当地耐药情况调整）\n  - 住院时快速感染筛查（血、尿、腹水培养；影像学）\n  - 早期广谱抗生素，随后根据培养结果去阶梯\n- 循证：\n  - SBP预防性抗生素可**显著降低SBP发生率和死亡率**\n  - 上消化道出血期短程抗生素可减少感染和再出血，提高生存\n- 综合路径使这些措施执行率更高，从而**降低感染相关失代偿和ACLF**。\n\n---\n\n### 6. 营养、肌少症与运动干预\n\n- 营养不良和肌少症是肝硬化患者预后不良的重要独立预测因素。\n- 指南（EASL、ESPEN 等）推荐：\n  - 能量：25–35 kcal/kg/d\n  - 蛋白：1.2–1.5 g/kg/d（除非极特殊情况，不再限制蛋白）\n  - 睡前加餐（late evening snack），优选复杂碳水+蛋白\n  - 避免不必要的禁食和输液性营养不良\n- 证据：\n  - 营养干预可改善体重、肌肉量、免疫功能\n  - 减少感染、住院和死亡\n- 适度阻力+有氧运动：\n  - 提高肌量和肌力，改善耐力和生活质量\n  - 有研究提示可降低跌倒和住院率\n- 综合管理中，由营养师+康复/运动治疗师参与，可**系统筛查和干预肌少症**，改善长期结局。\n\n---\n\n### 7. 多学科团队（MDT）与移植评估\n\n- MDT通常包括：肝病科、介入/影像、外科、ICU、营养、药学、心理/成瘾医学、社会工作等。\n- 系统评估：\n  - 移植时机（MELD、CPT、ACLF评分）\n  - 合并心肺、肾、营养状况\n- 循证与经验表明：\n  - 早期转介和纳入移植评估的患者，**等待期死亡率更低，移植后生存更好**\n  - MDT模式可减少“延误移植”或“不必要移植”的情况\n\n---\n\n## 三、指南共识：综合管理是“标准照护”，而非附加选项\n\n**主要指南**（AASLD、EASL、APASL、中国肝病相关指南等）都已从“按并发症被动治疗”转向“主动、系统、综合管理”理念，核心共识包括：\n\n1. 所有肝硬化患者应进行：\n   - 明确病因并给予针对性治疗\n   - 风险分层（CSPH、MELD、Child-Pugh、ACLF评分等）\n   - 定期HCC筛查与门脉高压评估\n2. 代偿期重点是：\n   - 病因控制 + 预防首发失代偿（NSBB、生活方式、代谢管理）\n3. 失代偿期重点是：\n   - 并发症综合管理（腹水、HE、出血、感染、AKI/HRS）\n   - 营养和肌少症干预\n   - 早期评估移植适应证\n4. 对急性失代偿/ACLF：\n   - 倡导在急诊/入院24小时内执行“care bundle”\n   - 以减少早期死亡和器官衰竭进展\n\n---\n\n## 四、总结：综合治疗管理对预后与并发症的影响\n\n基于最新循证指南的综合治疗管理，与传统零散、被动的随访模式相比，整体上可：\n\n1. **降低死亡率**\n   - 通过病因控制、预防失代偿、优化门脉高压和急性失代偿/ACLF的处理\n2. **减少失代偿事件和并发症**\n   - 静脉曲张出血、腹水、HE、SBP/其他感染、AKI/HRS等发生率明显下降\n3. **降低住院与再入院率**\n   - 通过规范用药、患者教育、营养与生活方式管理\n4. **改善生活质量和功能状态**\n   - 减少脑病发作、提高体力和心理状态\n5. **提高HCC早诊率和治愈性治疗机会**\n   - 规范监测与MDT决策\n6. **优化肝移植路径**\n   - 更合理的移植时机和候选人选择，提高总体生存获益\n\n如果你需要，我可以按“代偿期”和“失代偿期”分别列出一个**实际临床可执行的综合管理清单（checklist）**，或针对某一并发症（如腹水、脑病、出血）详细展开对应的循证管理策略与关键试验数据。", "rejected": "基于最新循证指南的综合治疗管理对肝硬化患者的临床预后和并发症控制具有**显著积极影响**，主要体现在以下几个方面：\n\n---\n\n### **一、对临床预后的改善**\n1. **提高生存率**  \n   - **病因治疗**：如抗病毒治疗（乙肝、丙肝）、戒酒、减肥（针对代谢相关脂肪性肝病），可延缓甚至逆转肝纤维化，降低肝癌和失代偿风险。\n   - **并发症预防**：通过规范管理门脉高压、腹水、感染等，减少急性失代偿事件，降低死亡率。\n\n2. **延缓疾病进展**  \n   - **早期干预**：通过定期筛查（如肝弹性检测、影像学）和风险评估，及时调整治疗策略，避免疾病进入失代偿期。\n   - **多学科协作**：结合肝病科、营养科、感染科等，全面管理合并症（如糖尿病、心血管疾病）。\n\n---\n\n### **二、对并发症的控制**\n1. **门脉高压与静脉曲张出血**  \n   - **一级预防**：非选择性β受体阻滞剂（如普萘洛尔）或内镜下套扎，降低首次出血风险。\n   - **急性出血管理**：指南推荐血管活性药物（如特利加压素）、内镜治疗+抗生素预防，显著降低再出血率和死亡率。\n   - **二级预防**：联合药物和内镜治疗，必要时行TIPS（经颈静脉肝内门体分流术）。\n\n2. **腹水与自发性细菌性腹膜炎（SBP）**  \n   - **限钠+利尿剂**：作为一线治疗，减少腹水复发。\n   - **腹腔穿刺放液**：大量腹水时及时引流，补充白蛋白防止循环功能障碍。\n   - **SBP预防**：对高危患者（如低蛋白腹水）使用喹诺酮类抗生素预防，降低感染相关死亡率。\n\n3. **肝性脑病（HE）**  \n   - **一线治疗**：乳果糖、利福昔明等降低血氨，结合营养支持（适量蛋白质摄入）。\n   - **病因管理**：纠正诱因（如感染、电解质紊乱），减少HE复发。\n\n4. **肝肾综合征（HRS）**  \n   - **早期识别**：根据新版指南（如ICA标准）快速诊断，使用血管收缩剂（如特利加压素+白蛋白）改善肾功能。\n   - **避免肾损伤**：慎用肾毒性药物，控制感染，合理使用利尿剂。\n\n5. **肝癌筛查**  \n   - **定期监测**：每6个月进行肝脏超声±AFP检测，早期发现肝癌，提高根治性治疗机会。\n\n---\n\n### **三、综合管理的核心要素**\n1. **个体化治疗**  \n   - 根据病因、肝功能分级（Child-Pugh/MELD评分）、并发症风险定制方案。\n\n2. **患者教育与自我管理**  \n   - 指导饮食（如低钠、适量蛋白）、戒酒、药物依从性，减少再住院。\n\n3. **新兴疗法整合**  \n   - **抗纤维化药物**（如针对NASH的新药）、**微生态调节**（益生菌预防HE）等逐步纳入临床实践。\n\n4. **终末期肝病的过渡管理**  \n   - 适时评估肝移植指征，优化移植前准备。\n\n---\n\n### **四、循证指南的实践挑战**\n- **医疗资源不均**：部分基层医院难以全面实施指南推荐（如内镜、TIPS技术）。\n- **患者依从性**：长期管理需患者积极参与，但受经济、教育水平影响。\n- **合并症管理**：如肥胖、糖尿病需多学科协作，目前整合仍需加强。\n\n---\n\n### **总结**\n遵循最新循证指南的综合管理，通过**病因控制、并发症规范化防治、多学科协作及患者全程管理**，可显著改善肝硬化患者生存质量，降低失代偿事件和死亡风险。未来需进一步推动指南落地、加强基层培训，并关注个体化治疗与新疗法的整合。\n\n（注：指南参考来源包括AASLD、EASL、APASL等国际肝病学会的最新共识及Cochrane系统评价。）"}

prompt = one_data["prompt"]
response1 = one_data["chosen"]
response2 = one_data["rejected"]
conv1 = [{"role": "user", "content": prompt}, {"role": "assistant", "content": response1}]
conv2 = [{"role": "user", "content": prompt}, {"role": "assistant", "content": response2}]

# Format and tokenize the conversations
conv1_formatted = tokenizer.apply_chat_template(conv1, tokenize=False)
conv2_formatted = tokenizer.apply_chat_template(conv2, tokenize=False)
# These two lines remove the potential duplicate bos token
if tokenizer.bos_token is not None and conv1_formatted.startswith(tokenizer.bos_token):
    conv1_formatted = conv1_formatted[len(tokenizer.bos_token):]
if tokenizer.bos_token is not None and conv2_formatted.startswith(tokenizer.bos_token):
    conv2_formatted = conv2_formatted[len(tokenizer.bos_token):]
conv1_tokenized = tokenizer(conv1_formatted, return_tensors="pt").to(device)
conv2_tokenized = tokenizer(conv2_formatted, return_tensors="pt").to(device)

# Get the reward scores
with torch.no_grad():
    score1 = rm(**conv1_tokenized).logits[0][0].item()
    score2 = rm(**conv2_tokenized).logits[0][0].item()
print(f"Score for response 1: {score1}")
print(f"Score for response 2: {score2}")

# Expected output:
# Score for response 1: 13.75
# Score for response 2: -9.375